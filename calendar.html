<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="calendar.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<title>Calendar</title>
</head>
<body>
	<button type="button" id="previous_month_btn">Last Month</button>
	<button type="button" id="next_month_btn">Next Month</button>
	<a href="logout.php">logout</a>
	<br>
	<table id="calendar_table">
		<caption id="current_month">Current Month: </caption>
		<tr>
		  <th>Sunday</th>
		  <th>Monday</th>
		  <th>Tuesday</th>
		  <th>Wednesday</th>
		  <th>Thursday</th>
		  <th>Friday</th>
		  <th>Saturday</th>
		</tr>
		
	  </table>


	<script>
		(function(){Date.prototype.deltaDays=function(c){return new Date(this.getFullYear(),this.getMonth(),this.getDate()+c)};Date.prototype.getSunday=function(){return this.deltaDays(-1*this.getDay())}})();
		function Week(c){this.sunday=c.getSunday();this.nextWeek=function(){return new Week(this.sunday.deltaDays(7))};this.prevWeek=function(){return new Week(this.sunday.deltaDays(-7))};this.contains=function(b){return this.sunday.valueOf()===b.getSunday().valueOf()};this.getDates=function(){for(var b=[],a=0;7>a;a++)b.push(this.sunday.deltaDays(a));return b}}
		function Month(c,b){this.year=c;this.month=b;this.nextMonth=function(){return new Month(c+Math.floor((b+1)/12),(b+1)%12)};this.prevMonth=function(){return new Month(c+Math.floor((b-1)/12),(b+11)%12)};this.getDateObject=function(a){return new Date(this.year,this.month,a)};this.getWeeks=function(){var a=this.getDateObject(1),b=this.nextMonth().getDateObject(0),c=[],a=new Week(a);for(c.push(a);!a.contains(b);)a=a.nextWeek(),c.push(a);return c}};

		// For our purposes, we can keep the current month in a variable in the global scope
		let currentMonth = new Month(2020, 06); 
		
		let htmlMonthObj = document.getElementById("current_month");
		htmlMonthObj.textContent += currentMonth.year+'.'+parseInt(currentMonth.month+1);
		let weeks = currentMonth.getWeeks();
		let dayRegex = /\d{2}/g;
		//console.log(weeks[0].getDates()[0].toISOString());
		let htmlTableObj = document.getElementById("calendar_table");
		for(let i=0; i<weeks.length; i++){
			let htmlWeekObj = htmlTableObj.appendChild(document.createElement("tr"));
			let currentWeek = weeks[i];
			for(let j=0; j<7; j++){
				let days = currentWeek.getDates();
				let htmlDayObj = htmlWeekObj.appendChild(document.createElement("td"));
				let day = days[j].toISOString();
				
				//set id value
				//htmlDayObj.setAttribute("id",day);
				let match_month=day.match(dayRegex)[2];
				let match = day.match(dayRegex)[3];
				let each= document.createElement("div");
				each.setAttribute("id", day);
				each.classList.add("td_div");
				//each.id=day;
				//console.log(day);
				//console.log(match_month);
				//console.log(currentMonth.month);
				if(match_month!=currentMonth.month+1){
					each.classList.add("not_this_month");
				}
				let div_arr=document.getElementsByClassName("td_div");
				$(each).click(function(){
					id=$(this).attr("id");
					$("#myform").show(500);
					$('#dateId').val(id);
					displayEventByDay(id);
				});
				// $(".td_div").click(function(){
				// 	id=$(this).attr("id");
                // 	$("#myform input[type=text]").val('');
				// 	$("#myform").show(500);
				// 	$('#dateId').val(id);
				// 	//console.log(id);
				// 	displayEventByDay(id);
				// });
				each.textContent=match;
				htmlDayObj.appendChild(each);
				DisplayEventAjax(day,each);
				//htmlDayObj.appendChild(document.createTextNode(match));
			}
		}
		// Change the month when the "last" button is pressed
		document.getElementById("previous_month_btn").addEventListener("click", function(event){
			currentMonth = currentMonth.prevMonth();
			let htmlTableObj = document.getElementById("calendar_table");
			htmlTableObj.innerHTML = "";
			let htmlCaptionObj = htmlTableObj.appendChild(document.createElement("caption"));
			htmlCaptionObj.appendChild(document.createTextNode("Current Month: "));
			updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
			//alert("The new month is "+currentMonth.month+" "+currentMonth.year);
			htmlCaptionObj.textContent += currentMonth.year+'.'+parseInt(currentMonth.month+1);
		}, false);

		// Change the month when the "next" button is pressed
		document.getElementById("next_month_btn").addEventListener("click", function(event){
			currentMonth = currentMonth.nextMonth();
			let htmlTableObj = document.getElementById("calendar_table");
			htmlTableObj.innerHTML = "";
			let htmlCaptionObj = htmlTableObj.appendChild(document.createElement("caption"));
			htmlCaptionObj.appendChild(document.createTextNode("Current Month: "));
			updateCalendar(); // Whenever the month is updated, we'll need to re-render the calendar in HTML
			//alert("The new month is "+currentMonth.month+" "+currentMonth.year);
			htmlCaptionObj.textContent += currentMonth.year+'.'+parseInt(currentMonth.month+1);
		}, false);
		
		
		function updateCalendar(){
			// let htmlTableObj = document.getElementById("calendar_table");
			// htmlTableObj.innerHTML = "";
			// let htmlCaptionObj = htmlTableObj.appendChild(document.createElement("caption"));
			// htmlCaptionObj.appendChild(document.createTextNode("Current Month: "))
			
			let htmlWeekObj = htmlTableObj.appendChild(document.createElement("tr"));
			for(let i=0; i<7; i++){
				let htmlDayObj = htmlWeekObj.appendChild(document.createElement("th"));
				let weekDays = ['Sunday', 'Monday','Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
				htmlDayObj.appendChild(document.createTextNode(weekDays[i]));
			}

			let weeks = currentMonth.getWeeks();
			let dayRegex = /\d{2}/g;

			for(let w in weeks){
				let htmlWeekObj = htmlTableObj.appendChild(document.createElement("tr"));
				let days = weeks[w].getDates();

				for(let d in days){
					let htmlDayObj = htmlWeekObj.appendChild(document.createElement("td"));
					let day = days[d].toISOString();
					//htmlDayObj.setAttribute("id", day)
					let match_month=day.match(dayRegex)[2];
					let match = day.match(dayRegex)[3];
					let each= document.createElement("div");
					each.classList.add("td_div");
					each.id=day;
					//console.log(match_month);
					//console.log(currentMonth.month);
					if(match_month!=currentMonth.month+1){
						each.classList.add("not_this_month");
					}
					$(".td_div").click(function(){
						id=$(this).attr("id");
						$("#myform input[type=text]").val('');
						$("#myform").show(500);
						$('#dateId').val(id);
					});
                	each.textContent=match;
					htmlDayObj.appendChild(each);
					DisplayEventAjax(day,each);
					//htmlDayObj.appendChild(document.createTextNode(match));
				}
			}
		}

		function DisplayEventAjax(day,each) {
			
			const data = {'day': day};
			// Make a URL-encoded string for passing POST data:
			//const data = { 'username': username, 'password': password };
			const token= document.getElementsByName("token").value;
			fetch("showevent.php", {
					method: 'POST',
					body: JSON.stringify(data),
					headers: { 'content-type': 'application/json' 
					//,'X-CSRF-Token': token 
					}
				})
			.then(response => response.json())
			.then(data => {
				console.log(data.success ? "Succesfully display event" : `Display event failed ${data.message}`);
				if(data.success==true){
					for(i=0;i<data.event.length;i++){
						let each_event=document.createElement("div");
						each_event.innerHTML=data.event[i]
						each.appendChild(each_event);
					}
				}
			})
			.catch(err => console.error(err));
			
		}

	</script>
	<div class="dialog" id="myform">
		<div id="dialog_events"></div>
		<form>
			<div>Event:</div>
			<textarea id="event_content"></textarea>
			<div>
				<span>Time:</span>
				<input type="text" id="time"/>
			</div>
			<input type="hidden" id="dateId" value="">
			<button id="add">add</button>
			<button id="cancel_add">X</button>
		</form>
	</div>

	<script>

		document.getElementById("cancel_add").addEventListener("click",function(event){
			event.preventDefault();
			$("#myform").hide(400);
		});
		document.getElementById("add").addEventListener("click",function(event){
			event.preventDefault();
			$("#myform").hide(400);
			event.preventDefault();
			const content = document.getElementById("event_content").value;
			const id = document.getElementById("dateId").value;
			let date = document.getElementById(id);
			console.log(date);
			let each = document.createElement("div");
			each.innerHTML = content;
			date.appendChild(each);
			console.log(id);
			const idRegex = /\d{4}-\d{2}-\d{2}\w\d{2}:/g;
			let sqlDate = id.match(idRegex);
			let time = document.getElementById("time").value;
			let dt = String(sqlDate+time+".000Z");
			//console.log(dt);
			const data = {'content': content, 'datetime': dt};
			fetch('addEvent.php', {
				method: "POST",
				body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(console.log(data))
			.catch(error => console.error(error));

		}, false);
		function displayEventByDay(id){
			document.getElementById("dialog_events").innerHTML="";
			const data = {'day': id};
			// Make a URL-encoded string for passing POST data:
			//const data = { 'username': username, 'password': password };
			const token= document.getElementsByName("token").value;
			fetch("showevent.php", {
					method: 'POST',
					body: JSON.stringify(data),
					headers: { 'content-type': 'application/json' 
					//,'X-CSRF-Token': token 
					}
				})
			.then(response => response.json())
			.then(data => {
				console.log(data.success ? "Succesfully display event" : `Display event failed ${data.message}`);
				if(data.success==true){
					for(i=0;i<data.event.length;i++){
						console.log(data.event);
						let each_event=document.createElement("div");
						let event_content=document.createElement("span");
						event_content.innerHTML=data.event[i];
						each_event.appendChild(event_content);
						let modify_button=document.createElement("button");
						modify_button.innerHTML="modify";
						modify_button.addEventListener("click",function(){
							console.log("modify");
						});
						each_event.appendChild(modify_button);
						let delete_button=document.createElement("button");
						delete_button.innerHTML="delete";
						each_event.appendChild(delete_button);
						document.getElementById("dialog_events").appendChild(each_event);
					}
				}
			})
			.catch(err => console.error(err));
			return;
		}
	</script>
</body>
</html>
